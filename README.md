# 実験参加者スケジューリングシステム

2名以上の参加者が必要な実験室実験やグループインタビュー向けの予約管理システムです。  
最小実施人数を設定でき、人数が集まった時点で自動的に実験実施が確定します。

## 🎯 このシステムでできること

- **自動マッチング**: 2名以上が同じ時間枠に申し込むと自動で実験実施が確定
- **最小実施人数の設定**: 2名、3名、4名など、実験に必要な最小人数を自由に設定可能
- **1名からの実施にも対応**: 設定次第で1名でも確定可能
- **キャンセル時の自動補充**: キャンセルが出ても待機者から自動で補充
- **メール通知**: 確定連絡、前日リマインダーを自動送信

## 📋 必要なもの

- Googleアカウント
- インターネット環境
- 約30分の作業時間

## 🚀 セットアップ手順

### ステップ1: スプレッドシートの作成

1. [Google スプレッドシート](https://sheets.google.com)にアクセス
2. 「空白」のスプレッドシートを新規作成
3. スプレッドシートの名前を「実験スケジューラー」などに変更

### ステップ2: スクリプトエディタを開く

1. メニューバーから「拡張機能」→「Apps Script」をクリック
2. 新しいタブでスクリプトエディタが開きます

### ステップ3: コードの設置

#### 3-1. 既存のコードを削除
スクリプトエディタに最初から書かれている以下のコードを**すべて削除**してください：
```javascript
function myFunction() {
  
}
```

#### 3-2. ファイルの作成と配置

以下の順番で新しいファイルを作成し、コードをコピー＆ペーストしてください。

**ファイルの作成方法**:
1. 左側の「ファイル」の横の「＋」ボタンをクリック
2. 「スクリプト」を選択
3. ファイル名を入力（例: `Setting`）※ .gs は自動で付きます

**必要なファイル一覧**（この順番で作成してください）:

1. **Code.gs** （最初からあるファイルを使用）
2. **Setting.gs** ⚠️ **必ず修正が必要**
3. **Templates.gs** ⚠️ **必ず修正が必要**
4. **Utils.gs**
5. **BatchProcess.gs**
6. **Mail.gs**
7. **Cancel.gs**
8. **AddSlots.gs**
9. **DataCleanup.gs**
10. **Menu.gs**
11. **Index.html**

各ファイルのコードは[こちらのGitHubリポジトリ](https://github.com/YukiInoueNakata/experiment-scheduler-gas)からコピーしてください。

### ⚠️ ステップ4: 必須設定の変更

#### 📍 **超重要: スプレッドシートIDの設定**

**Setting.gs** の最初の部分を**必ず**修正してください：

1. スプレッドシートのURLを確認
   - URLは次のような形式です：
   ```
   https://docs.google.com/spreadsheets/d/【ここがID】/edit#gid=0
   ```
   
2. 【ここがID】の部分（約44文字の英数字）をコピー

3. **Setting.gs** の以下の部分に貼り付け：
   ```javascript
   // ★ スプレッドシートID（必須）
   // URLの /d/ と /edit の間の文字列をここに貼り付けてください
   const SS_ID = 'ここにIDを貼り付け';  // ← 絶対に変更してください！！
   ```

   **例**:
   ```javascript
   const SS_ID = '1a2B3c4D5e6F7g8H9i0J1k2L3m4N5o6P7q8R9s0T1u2V';
   ```

#### 📝 Setting.gs - 重要な設定項目

```javascript
const CONFIG = {
  // ===== 基本設定 =====
  title: '実験参加スケジュール',  // Webページのタイトル
  tz: 'Asia/Tokyo',                // タイムゾーン（日本）

  // ===== 実験期間の設定 =====
  startDate: '2025-09-01',  // 実験開始日（YYYY-MM-DD形式）
  endDate:   '2025-09-30',  // 実験終了日（YYYY-MM-DD形式）
  
  // ===== 時間枠の設定 =====
  // 1日の中で実験を行う時間帯を設定
  timeWindows: [
    '11:00-12:00',  // 午前の部
    '13:20-14:20',  // 午後の部1
    '15:00-16:00',  // 午後の部2  
    '16:50-17:50'   // 午後の部3
  ],
  
  // ===== 人数設定（最重要） =====
  capacity: 2,              // 1枠の最大人数（定員）
  minCapacityToConfirm: 2,  // 実験実施に必要な最小人数
  
  // 【設定例】
  // ■ 2名ペア実験の場合：
  //   capacity: 2, minCapacityToConfirm: 2
  //   → 2名揃ったら確定、定員も2名
  //
  // ■ 3～4名のグループ実験の場合：
  //   capacity: 4, minCapacityToConfirm: 3
  //   → 3名以上集まれば確定、最大4名まで
  //
  // ■ 1名でも実施可能な実験の場合：
  //   capacity: 3, minCapacityToConfirm: 1
  //   → 1名でも確定、最大3名まで

  // ===== 除外日設定 =====
  excludeWeekends: true,  // 土日を除外する場合はtrue
  excludeDates: [         // 特定の日付を除外（祝日など）
    '2025-09-16',  // 敬老の日
    '2025-09-23'   // 秋分の日
  ],
  
  // ===== 場所情報 =====
  location: '○○大学 ○○キャンパス ○号館 ○F 実験室A',  // ← 必ず変更
  
  // ===== メール設定 =====
  adminEmails: ['your-email@example.com'],  // ← 管理者メールアドレス（必ず変更）
  mailFromName: '実験担当（自動送信）',        // 送信者名
  
  // ===== その他の設定 =====
  showOnlyFromTomorrow: true,              // 明日以降の枠のみ表示
  allowMultipleConfirmationPerEmail: false, // 1人1枠まで（falseの場合）
  batchProcessDelaySeconds: 30,            // 申込み後の確定処理待機時間（秒）
};
```

#### ⚠️ Templates.gs - メール文面と同意文の変更

**Templates.gs** のメール文面と同意文は**必ず実験内容に合わせて変更してください**：

```javascript
// ===== 重要: 同意文を必ず変更してください =====
consentHtml: [
  '<h2>研究のご説明と同意</h2>',
  '<p>この研究は【研究目的をここに記載】を目的とし、2名での【実験内容】を通じてデータを取得します。</p>',
  '<p>所要時間は約【○○分】、謝礼は【金額または内容】です。</p>',
  // ... 実験に応じて適切な同意文に変更
].join('')

// ===== メール文面も実験に合わせて変更 =====
participant: {
  receiptSubject: '【受付】実験参加のお申込みを受け付けました',
  receiptBody: // ... 実験に応じた内容に変更
}
```

**⚠️ 注意**: 現在の同意文は**サンプルです**。必ず倫理審査を通過した適切な同意文に差し替えてください。

### ステップ5: 初期設定の実行

1. スクリプトエディタで「Code.gs」を開く
2. 関数選択ドロップダウンから `setup` を選択
3. 「実行」ボタンをクリック
4. 初回実行時は権限の承認が必要です
   - 「権限を確認」→「詳細」→「安全ではないページに移動」→「許可」

### ステップ6: Webアプリのデプロイ

1. スクリプトエディタの右上「デプロイ」→「新しいデプロイ」
2. 設定：
   - 種類: 「ウェブアプリ」
   - 説明: 「実験予約システム」
   - 実行ユーザー: 「自分」
   - アクセス権: 「全員」
3. 「デプロイ」ボタンをクリック
4. **表示されたURLを必ず保存してください**

**URLを忘れた場合**:
「デプロイ」→「デプロイを管理」から確認できます

## 📧 メールテスト

本番運用前に必ずメールテストを実行してください：

1. スプレッドシートを開く
2. メニューバーに「スケジューラー」が表示されているか確認
3. 「スケジューラー」→「🧪テスト機能」→「📧 メールテスト」→「全メールテスト」
4. TestMailLogシートで送信予定のメールを確認

## 🎮 運用方法

### 実験枠の追加（AddSlots）

1. スプレッドシートの「AddSlots」シートを開く
2. 以下の形式でデータを入力：

| Mode | Date | FromDate | ToDate | TimeWindows | ExcludeWeekends | Status |
|------|------|----------|--------|-------------|-----------------|--------|
| date | 2025-10-01 | | | | FALSE | |
| range | | 2025-10-01 | 2025-10-07 | | TRUE | |

- **Mode**: 
  - `date`: 特定の1日
  - `range`: 期間指定
- **ExcludeWeekends**: 週末を除外する場合TRUE

3. 「スケジューラー」→「操作パネルを開く」→「AddSlotsを実行」

### キャンセル処理（CancelOps）

1. 「CancelOps」シートを開く
2. キャンセル対象者の情報を入力：

| Email | Scope | SlotPolicy | FillPolicy | Reason |
|-------|-------|------------|------------|--------|
| user@example.com | confirmed | refill-slot | try-fill | 体調不良 |

3. 「スケジューラー」→「操作パネルを開く」→「CancelOpsを実行」

## ❓ よくある質問

### Q: 最小人数に満たない場合はどうなりますか？
A: 申込み状態（pending）のまま待機し、人数が揃った時点で自動的に確定メールが送信されます。

### Q: 1名でも実験を実施したい場合は？
A: Setting.gsで `minCapacityToConfirm: 1` に設定してください。

### Q: 申込み締切日を設定できますか？
A: 実験日の前日まで申込み可能です。締切を早めたい場合は該当スロットを「Slots」シートから削除してください。

### Q: メールが送信されません
A: Googleアカウントの1日のメール送信上限（100通）を確認してください。

### Q: エラーが発生しました
A: 以下を確認してください：
1. SS_IDが正しく設定されているか
2. すべてのファイルがコピーされているか
3. setupが実行されているか

### Q: 実験を中止したい場合は？
A: CancelOpsで `SlotPolicy: drop-slot` を選択すると、その枠全体をキャンセルできます。

## 📝 カスタマイズのヒント

- **3名以上の実験**: capacityとminCapacityToConfirmを調整
- **複数の実験室**: locationを枠ごとに設定可能
- **謝礼の自動計算**: コードをカスタマイズして対応可能

## 🆘 サポート

### トラブルシューティングガイド

#### よくあるエラーと解決方法

| エラーメッセージ | 原因 | 解決方法 |
|--------------|------|---------|
| `TypeError: Cannot read property 'getSheetByName' of null` | SS_IDが設定されていない | Setting.gsのSS_IDを設定 |
| `myFunction is not defined` | 不要なコードが残っている | 各.gsファイルのmyFunction()を削除 |
| `Unexpected token '<'` | Index.htmlがスクリプトとして作成された | Index.htmlを削除して「HTML」として再作成 |
| `スクリプトが見つかりません` | ファイル名が間違っている | ファイル名を確認（大文字小文字も一致させる） |
| `権限がありません` | 初回実行時の承認不足 | setupを再実行して権限を承認 |

### チェックリスト

セットアップがうまくいかない場合、以下を順番に確認してください：

- [ ] スプレッドシートのURLからIDを正しくコピーしたか
- [ ] SS_IDを`''`の中に貼り付けたか（`'`を消していないか）
- [ ] すべての.gsファイルからmyFunction()を削除したか
- [ ] Index.htmlは「HTML」として作成したか
- [ ] Index.htmlの既存コードを削除してからコピーしたか
- [ ] setupを実行して「完了」と表示されたか
- [ ] スプレッドシートに各シートが自動生成されたか

問題が解決しない場合は、以下の情報と共にお問い合わせください：
- エラーメッセージのスクリーンショット
- Setting.gsの設定内容（SS_IDは除く）
- 実行した操作の手順

---

**開発者向け情報**: 
- 上級者の方は[GitHubリポジトリ](https://github.com/YukiInoueNakata/experiment-scheduler-gas)から直接claspを使用してデプロイすることも可能です
- プルリクエストやイシューでの改善提案を歓迎します
